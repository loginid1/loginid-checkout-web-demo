<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
		/>
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/icon?family=Material+Icons"
		/>
		<meta
			http-equiv="Permissions-Policy"
			content="publickey-credentials-get=*"
		/>

		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<meta
			name="description"
			content="A simple shopping cart created using the Material UI framework"
		/>
		<title>CDN Test</title>
	</head>

	<body>
		<noscript>You need to enable JavaScript to run this app.</noscript>

		<script>
			const PUBLIC_KEY = {
				x: "Ggyohh3_jONLEJYWEraykHnZrJyJdwAg-12gc3VvY9w",
				y: "ovaMeCM3lDHQfMJt5e8SHCy9fnZOf4apjgiL6FKu5zo",
				crv: "P-256",
				kty: "EC",
				use: "sig",
			};

			const API_BASEURL = "https://0c5a-104-247-246-171.ngrok-free.app";
			const PROTECTED_PAGES = [
				"/Users/loginid/workspace/loginid-algo/test-cdn/crypto.html",
			];
			const LOGIN_PAGE = "/Users/loginid/workspace/loginid-algo/test-cdn/index.html";

			checkAuthorizePage(API_BASEURL, PUBLIC_KEY, PROTECTED_PAGES, LOGIN_PAGE);

			async function checkToken(apiUrl, publicKey) {
				const token = localStorage.getItem("loginid-token");

				if (token == null) {
					console.log("no token");
					return Promise.resolve(false);
				}

				let signature = localStorage.getItem("loginid-token-signature");
				if (signature == null) {
					// fetch signature from site
					let tokenResponse = await getTokenSignature(apiUrl, token);
					console.log("sign: " + tokenResponse.signature);
					signature = tokenResponse.signature;
					localStorage.setItem("loginid-token-signature", signature);
				}

				if (signature == null) {
					console.log("no signature");
					return Promise.resolve(false);
				}

				let importKey = await window.crypto.subtle.importKey(
					"jwk",
					publicKey,
					{
						name: "ECDSA",
						namedCurve: "P-256",
					},
					true,
					["verify"]
				);

				let encoder = new TextEncoder();

				console.log(base64ToArrayBuffer(signature));
				let result = await window.crypto.subtle.verify(
					{
						name: "ECDSA",
						hash: { name: "SHA-256" },
					},
					importKey,
					base64ToArrayBuffer(signature),
					encoder.encode(token)
				);
				console.log("final result: " + result);
				return Promise.resolve(result);
			}

			async function checkAuthorizePage(apiUrl, publicKey, protectedPages, loginPage) {
				const path = document.location.pathname;
				console.log("check authorize: " + path);
				if (matchProtectedPage(protectedPages, path)) {
					const validToken = await checkToken(apiUrl, publicKey);
					if (!validToken) {
						console.log("invalid token");
						// redirect to login page
						location.href=loginPage;
					}
					console.log("successful continue");
				}
			}

			async function getTokenSignature(apiUrl, token) {
				try {
					const response = await fetch(
						apiUrl + "/webflow/validateToken",
						{
							method: "POST",
							body: JSON.stringify({
								token: token,
								vendor: "webflow",
							}),
							redirect: "follow",
							headers: {
								"Content-Type": "application/json",
							},
						}
					);
					if (response.ok) {

						let json = await response.json();
						console.log(json);
						return Promise.resolve(json);
					} else {
						Promise.reject("error ");
					}
				} catch (error) {
					console.log("error: " + error);
					Promise.reject("error ");
				}
			}

			function base64ToArrayBuffer(base64) {
				var binaryString = atob(base64);
				var bytes = new Uint8Array(binaryString.length);
				for (var i = 0; i < binaryString.length; i++) {
					bytes[i] = binaryString.charCodeAt(i);
				}
				return bytes.buffer;
			}

function matchProtectedPage(pages, path){
    for(let page of pages) {
        if(path.includes(page)){
            return true;
        }
    }
    return false;
}
		</script>
		<div id="root">
			<a
				id="loginid-button"
				href="test"
				loginid-success="test"
				loginid-api=""
				>Crypto Button</a
			>
		</div>
	</body>
</html>
