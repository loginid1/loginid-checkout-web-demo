<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
		/>
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/icon?family=Material+Icons"
		/>
		<meta
			http-equiv="Permissions-Policy"
			content="publickey-credentials-get=*"
		/>

		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
		<meta
			name="description"
			content="A simple shopping cart created using the Material UI framework"
		/>
		<title>CDN Test</title>
	</head>

	<body>
		<noscript>You need to enable JavaScript to run this app.</noscript>
		<script src="https://loginid-wallet-cdn.s3.us-east-2.amazonaws.com/loginid-wallet-sdk.min.js"></script>
		<script>
			window.onload = function () {
				testCrypto();
				const loginidDom = document.getElementById("loginid-button");
				loginidDom.addEventListener("click", async function (event) {
					event.preventDefault();
					let api = loginidDom.getAttribute("loginid-api");
					if (api == null) {
						api = "";
					}
					const wallet = new loginid.WalletSDK(
						"https://7aaf-104-247-246-171.ngrok-free.app",
						api,
						null
					);
					const response = await wallet.signup();
					document.cookie = "loginid-token=" + response.token;

					let redirect_success =
						loginidDom.getAttribute("loginid-success");
					if (redirect_success) {
						document.location.href = redirect_success;
					} else {
						redirect_success = loginidDom.getAttribute("href");
						document.location.href = redirect_success;
					}
				});
			};

			/*
        window.onload = function () {
            let loginidDom = document.getElementById("loginid-button");
            loginidDom.addEventListener('click', function(event){
                event.preventDefault();
                onSignup();
            });

        }
        async function onSignup(button) {
            let loginidDom = document.getElementById("loginid-button");
            let api = loginidDom.getAttribute("loginid-api");
            if(api == null) {
                api = "";
            }
            const wallet = new loginid.WalletSDK("https://vault.testnet.loginid.io", api, null)
            try {
                let result = await wallet.signup();
	            document.cookie = 'loginid-token='+response.token;
                
                let redirect_success = loginidDom.getAttribute("loginid-success");
                if (redirect_success) {
                    document.location.href=redirect_success;
                } else {
                    redirect_success = loginidDom.getAttribute("href");
                    document.location.href=redirect_success;
                }

            } catch (error) {
                console.log(error);
            }
        }
        */

			const publicKey = {
				x: "Ggyohh3_jONLEJYWEraykHnZrJyJdwAg-12gc3VvY9w",
				y: "ovaMeCM3lDHQfMJt5e8SHCy9fnZOf4apjgiL6FKu5zo",
				crv: "P-256",
				kty: "EC",
				use: "sig",
			};

			const privateKey = {
				d: "qTC_XanBj_-T8H57Ryf0IyX5UfXkjEfARchRZVWhXh8",
				x: "Ggyohh3_jONLEJYWEraykHnZrJyJdwAg-12gc3VvY9w",
				y: "ovaMeCM3lDHQfMJt5e8SHCy9fnZOf4apjgiL6FKu5zo",
				crv: "P-256",
				kty: "EC",
				use: "sig",
			};
			const api_baseurl = "https://0c5a-104-247-246-171.ngrok-free.app";
			const protectedPages = [
				"/Users/loginid/workspace/loginid-algo/test-cdn/index.html",
			];
			const loginPage = "/login";
			generateSignature();
			checkAuthorizePage();

			async function generateSignature() {
				let importKey = await window.crypto.subtle.importKey(
					"jwk",
					privateKey,
					{
						name: "ECDSA",
						namedCurve: "P-256",
					},
					true,
					["sign"]
				);

				const token = localStorage.getItem("loginid-token");

				if (token == null) {
					console.log("no token");
					return Promise.resolve(false);
				}


				let encoder = new TextEncoder();
				const data = encoder.encode(token);
  				const hash = await crypto.subtle.digest("SHA-256", data);

				console.log("Token: " + token + " hash: " + hash);
				let signature = await window.crypto.subtle.sign(
					{
						name: "ECDSA",
						hash: { name: "SHA-256" },
					},
					importKey,
					encoder.encode(token),	
				);
				console.log("generated sig: " + arrayBufferToBase64(signature));
			}

			async function checkToken() {
				document.cookie =
					"loginid-token=eyJhbGciOiJFUzI1NiIsImtpZCI6ImY4YjJlNjNkLTE3MmQtNGRiZi04YjAzLWU4MzZlMzk0YmQ2YSIsInR5cCI6IkpXVCJ9";
				console.log("store cookies");
				localStorage.setItem(
					"loginid-token",
					"eyJhbGciOiJFUzI1NiIsImtpZCI6ImY4YjJlNjNkLTE3MmQtNGRiZi04YjAzLWU4MzZlMzk0YmQ2YSIsInR5cCI6IkpXVCJ9.eyJjbGllbnQiOiI3ZGUzMTUyOC0zNzk4LTRkNGItYTVlMC1hM2U2NjdiNTE2ZmUiLCJpYXQiOjE2OTI5MTM2MTQsInN1YiI6InRlc3RwMjBAZ3JyLmxhIn0.FIN2P6p89oqXQPasr7dsaUt0sRznVIzaPwua6D3n7P0Gjg7SVmbc63Ma5k0YUw60p--CU-bGMQnzLTEWut50fQ"
				);
				/*
				const token = document.cookie
					.split("; ")
					.find((row) => row.startsWith("loginid-token="))
					?.split("=")[1];
				*/
				const token = localStorage.getItem("loginid-token");

				if (token == null) {
					console.log("no token");
					return Promise.resolve(false);
				}

				let signature = localStorage.getItem("loginid-token-signature");
				if (signature == null) {
					// fetch signature from site
					let tokenResponse = await getTokenSignature(token);
					console.log("sign: " + tokenResponse);
					signature = tokenResponse.signature;
				}

				if (signature == null) {
					consoel.log("no signature");
					return Promise.resolve(false);
				}

				let importKey = await window.crypto.subtle.importKey(
					"jwk",
					publicKey,
					{
						name: "ECDSA",
						namedCurve: "P-256",
					},
					true,
					["verify"]
				);

				let encoder = new TextEncoder();

				console.log(base64ToArrayBuffer(signature));
				let result = await window.crypto.subtle.verify(
					{
						name: "ECDSA",
						hash: { name: "SHA-256" },
					},
					importKey,
					base64ToArrayBuffer(signature),
					encoder.encode(token)
				);
				console.log("final result: " + result);
				return Promise.resolve(result);
			}

			async function checkAuthorizePage() {
				const path = document.location.pathname;
				console.log("check authorize: " + path);
				if (protectedPages.includes(path)) {
					const validToken = await checkToken();
					if (!validToken) {
						console.log("invalid token");
						// redirect to login page
					}
				}
			}

			async function getTokenSignature(token) {
				try {
					const response = await fetch(
						api_baseurl + "/webflow/validateToken",
						{
							method: "POST",
							body: JSON.stringify({
								token: token,
								vendor: "webflow",
							}),
							redirect: "follow",
							headers: {
								"ngrok-skip-browser-warning": "69420",
								"Content-Type": "application/json",
							},
						}
					);
					let json = await response.json();
					console.log(json);
					return json;
				} catch (error) {
					console.log("error: " + error);
				}
			}

			async function testCrypto() {
				let keyPair = await window.crypto.subtle.generateKey(
					{
						name: "ECDSA",
						namedCurve: "P-256",
					},
					true,
					["sign", "verify"]
				);

				let pk = await window.crypto.subtle.exportKey(
					"jwk",
					keyPair.publicKey
				);

				let encoder = new TextEncoder();

				let signature = await window.crypto.subtle.sign(
					{
						name: "ECDSA",
						hash: { name: "SHA-256" },
					},
					keyPair.privateKey,
					encoder.encode("test")
				);

				console.log(signature);

				let testJWK = { x: pk.x, y: pk.y, kty: pk.kty, crv: pk.crv };
				let importKey = await window.crypto.subtle.importKey(
					"jwk",
					testJWK,
					{
						name: "ECDSA",
						namedCurve: "P-256",
					},
					true,
					["verify"]
				);

				console.log("sig format: ", signature);
				let result = await window.crypto.subtle.verify(
					{
						name: "ECDSA",
						hash: { name: "SHA-256" },
					},
					keyPair.publicKey,
					signature,
					encoder.encode("test")
				);
				console.log("test crypto: " + result);
			}

			function arrayBufferToBase64(buffer) {
				var binary = "";
				var bytes = new Uint8Array(buffer);
				var len = bytes.byteLength;
				for (var i = 0; i < len; i++) {
					binary += String.fromCharCode(bytes[i]);
				}
				return window.btoa(binary);
			}

			function base64ToArrayBuffer(base64) {
				var binaryString = atob(base64);
				var bytes = new Uint8Array(binaryString.length);
				for (var i = 0; i < binaryString.length; i++) {
					bytes[i] = binaryString.charCodeAt(i);
				}
				return bytes.buffer;
			}

			function base64ToBuffer(data) {
				data = data.replace(/-/g, "+").replace(/_/g, "/");
				const binary = a2b(data);
				const bytes = new Uint8Array(binary.length);
				for (let i = 0; i < binary.length; i++) {
					bytes[i] = binary.charCodeAt(i);
				}

				return bytes.buffer;
			}

			function a2b(a) {
				let b,
					c,
					d,
					e = {},
					f = 0,
					g = 0,
					h = "",
					i = String.fromCharCode,
					j = a.length;
				for (b = 0; 64 > b; b++) {
					e[
						"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(
							b
						)
					] = b;
				}
				for (c = 0; j > c; c++) {
					for (
						b = e[a.charAt(c)], f = (f << 6) + b, g += 6;
						g >= 8;

					) {
						((d = 255 & (f >>> (g -= 8))) || j - 2 > c) &&
							(h += i(d));
					}
				}
				return h;
			}
		</script>
		<div id="root">
			<a
				id="loginid-button"
				href="test"
				loginid-success="test"
				loginid-api=""
				>Login Button</a
			>
		</div>
	</body>
</html>
